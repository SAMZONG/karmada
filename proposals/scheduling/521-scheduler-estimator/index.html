<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Cluster Accurate Scheduler Estimator - Karmada.io</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">Karmada.io</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">What's Karmada <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="/" class="dropdown-item">Karmada</a>
</li>
                                    
<li>
    <a href="../../../istio-on-karmada/" class="dropdown-item">Use Istio on Karmada</a>
</li>
                                    
<li>
    <a href="../../../multi-cluster-ingress/" class="dropdown-item">Multi-cluster Ingress</a>
</li>
                                    
<li>
    <a href="../../../multi-cluster-service/" class="dropdown-item">Multi-cluster Service Discovery</a>
</li>
                                    
<li>
    <a href="../../../frequently-asked-questions/" class="dropdown-item">FAQ(Frequently Asked Questions)</a>
</li>
                                    
<li>
    <a href="../../../reserved-namespaces/" class="dropdown-item">Reserved Namespaces</a>
</li>
                                    
<li>
    <a href="../../../object-association-map/" class="dropdown-item">Karmada Object association mapping</a>
</li>
                                    
<li>
    <a href="../../../bash-auto-completion-on-linux/" class="dropdown-item">bash auto-completion on Linux</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../userguide/aggregated-api-endpoint/" class="dropdown-item">aggregated-api-endpoint</a>
</li>
                                    
<li>
    <a href="../../../userguide/cluster-registration/" class="dropdown-item">cluster-registration</a>
</li>
                                    
<li>
    <a href="../../../userguide/configure-controllers/" class="dropdown-item">configure-controllers</a>
</li>
                                    
<li>
    <a href="../../../userguide/customizing-resource-interpreter/" class="dropdown-item">customizing-resource-interpreter</a>
</li>
                                    
<li>
    <a href="../../../userguide/override-policy/" class="dropdown-item">override-policy</a>
</li>
                                    
<li>
    <a href="../../../userguide/promote-legacy-workload/" class="dropdown-item">promote-legacy-workload</a>
</li>
                                    
<li>
    <a href="../../../userguide/propagate-dependencies/" class="dropdown-item">propagate-dependencies</a>
</li>
                                    
<li>
    <a href="../../../userguide/resource-propagating/" class="dropdown-item">resource-propagating</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../installation/installation/" class="dropdown-item">Installation</a>
</li>
                                    
<li>
    <a href="../../../installation/install-kubectl-karmada/" class="dropdown-item">Install kubectl Karmada</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Upgrading <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../upgrading/" class="dropdown-item">upgrading</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Working With <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../working-with-anp/" class="dropdown-item">Deploy apiserver-network-proxy (ANP)</a>
</li>
                                    
<li>
    <a href="../../../working-with-argocd/" class="dropdown-item">Working with Argo CD</a>
</li>
                                    
<li>
    <a href="../../../working-with-filebeat/" class="dropdown-item">Use Filebeat to collect logs of Karmada member clusters</a>
</li>
                                    
<li>
    <a href="../../../working-with-flux/" class="dropdown-item">Use Flux to support Helm chart propagation</a>
</li>
                                    
<li>
    <a href="../../../working-with-gatekeeper/" class="dropdown-item">Working with Gatekeeper(OPA)</a>
</li>
                                    
<li>
    <a href="../../../working-with-kyverno/" class="dropdown-item">Working with Kyverno</a>
</li>
                                    
<li>
    <a href="../../../working-with-prometheus/" class="dropdown-item">Use Prometheus to monitor Karmada member clusters</a>
</li>
                                    
<li>
    <a href="../../../working-with-submariner/" class="dropdown-item">Use Submariner to connect the network between Karmada member clusters</a>
</li>
                                    
<li>
    <a href="../../../working-with-velero/" class="dropdown-item">Integrate Velero to back up and restore Karmada resources</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../../../troubleshooting/" class="nav-link">troubleshooting</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#cluster-accurate-scheduler-estimator" class="nav-link">Cluster Accurate Scheduler Estimator</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#summary" class="nav-link">Summary</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#motivation" class="nav-link">Motivation</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#proposal" class="nav-link">Proposal</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#design-details" class="nav-link">Design Details</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="cluster-accurate-scheduler-estimator">Cluster Accurate Scheduler Estimator</h1>
<h2 id="summary">Summary</h2>
<p>As workloads in multi-clusters become more heterogeneous, it is natural that they have different scheduling needs such as NodeSelector, NodeAffinity and Tolerations. Meanwhile, the scheduler could not perceive free node resource of every node in member cluster accurately.</p>
<p>This KEP proposes a new component, Karmada Cluster Accurate Scheduler Estimator, to enhance the accurate scheduling for Karmada Scheduler. It aims for estimating available replicas and return the result back to Karmada Scheduler for decision reference。</p>
<h2 id="motivation">Motivation</h2>
<p>There is currently no right way for Karmada Scheduler to perceive the dynamic node resource and pod request resource of the member clusters. The scheduler could only know the total resource situation of a member cluster according to the <code>NodeSummary</code> and <code>ResourceSummary</code> in <code>Cluster.Status</code>. If a workload specifies the replica resource claim, we should know how many available replicas a member cluster could produce in case of propagating too many replicas, which may lead to pending pods that fail to be scheduled.</p>
<p>The Cluster Accurate Scheduler Estimator aims to fix these problems.</p>
<h3 id="goals">Goals</h3>
<ul>
<li>Make the available replica estimation more acurate for scheduler decision reference.</li>
<li>Allow user to specify node claim such as <code>NodeAffinity</code>, <code>NodeSelector</code> and <code>Tolerations</code> for multi-cluster scheduling.</li>
</ul>
<h3 id="non-goals">Non-Goals</h3>
<ul>
<li>Estimating how many pods have failed to been scheduled for rescheduling decision reference.</li>
<li>Estimating available replicas groups in group and gang scheduling.</li>
</ul>
<h2 id="proposal">Proposal</h2>
<p>This proposal gives a new component to estimate the maximum available replica of a workload. When assigning replicas, the Karmada Scheduler parallelly requests the corresponding Cluster Accurate Scheduler Estimators for estimation by gRPC request.</p>
<p>This proposal is divided into several steps, see below:</p>
<ul>
<li>[ ] <code>ResourceBinding</code> API changes to add <code>NodeAffinity</code>, <code>NodeSelector</code> and <code>Tolerations</code>.</li>
<li>[ ] Definition of proto and gRPC struct file.</li>
<li>[ ] Estimator client integration in Karmada Scheduler.</li>
<li>[ ] Estimator server development in Karmada Cluster Accurate Scheduler Estimator.</li>
<li>[ ] Deployment script of Karmada Cluster Accurate Scheduler Estimator.</li>
<li>[ ] Associated docs and architecture diagram as a supplement.</li>
</ul>
<h3 id="user-stories">User Stories</h3>
<h4 id="story-1">Story 1</h4>
<p>Imagine that we have 1 workload and 2 member clusters, and the <code>ReplicaDivisionPreference</code> is <code>Aggregated</code>.
- Condition:
  - Cluster A has 10 nodes and each has 8 cpu remaining.
  - Cluster B has 2 nodes and each has 16 cpu remaining.
  - Workload has 1 replica and requests for 12 cpu.
- Result:
  - Workload will be scheduled to Cluster A because it has more cpu remaining in total. However, it won't work because there is no node that could match the 12-cpu request.
  - Only Cluster B can handle the workload's request but its total resource does not have a competitiveness.</p>
<h4 id="story-2">Story 2</h4>
<p>Imagine that 1 workload has a <code>NodeSelector</code> of "key=value", and the <code>ReplicaDivisionPreference</code> is <code>Aggregated</code>.
- Condition:
  - Cluster A has 10 nodes and each has 16 cpu remaining.
  - Cluster B has 2 nodes, which have a label of "key=value" and each node has 16 cpu remaining.
  - Workload has 1 replica with a <code>NodeSelector</code> of "key=value" and requests for 12 cpu.
- Result:
  - Workload will be scheduled to Cluster A because it has more cpu remaining in total. However, it won't work because there is no node that could match the <code>NodeSelector</code>.
  - Only Cluster B can handle the workload's request but its total resource does not have a competitiveness.</p>
<h2 id="design-details">Design Details</h2>
<p>The cluster maximum available replicas result has a significant influence with the scheduling. To solve this problem, we could change the way that we estimate the cluster available replicas. Note that it is now estimated by resource summary of a cluster. This function could be converted into a new scheduler plugin type.</p>
<p>Here's the architecture design diagram.</p>
<p><img alt="design" src="design.png" /></p>
<h3 id="api-changes">API Changes</h3>
<p>First, the API of <code>ResourceBinding</code> must be changed. <code>NodeAffinity</code>, <code>NodeSelector</code> and <code>Tolerations</code> would be added as a representative for <code>NodeClaim</code> along with the existed <code>ResourceRequest</code>. It is noticed that <code>ReplicaResourceRequirements</code> and <code>Replicas</code> is now in <code>ObjectReference</code>. It would be better to move these two fields in <code>ResourceBindingSpec</code>.</p>
<pre><code class="language-go">// ResourceBindingSpec represents the expectation of ResourceBinding.
type ResourceBindingSpec struct {
    // Resource represents the Kubernetes resource to be propagated.
    Resource ObjectReference `json:&quot;resource&quot;`

    // ReplicaRequirements represents the requirements required by each replica.
    // +optional
    ReplicaRequirements *ReplicaRequirements `json:&quot;replicaRequirements,omitempty&quot;`

    // Replicas represents the replica number of the referencing resource.
    // +optional
    Replicas int32 `json:&quot;replicas,omitempty&quot;`

    // Clusters represents target member clusters where the resource to be deployed.
    // +optional
    Clusters []TargetCluster `json:&quot;clusters,omitempty&quot;`
}

// ReplicaRequirements represents the requirements required by each replica.
type ReplicaRequirements struct {
    // NodeClaim represents the node claim HardNodeAffinity, NodeSelector and Tolerations required by each replica.
    // +optional
    NodeClaim *NodeClaim `json:&quot;nodeClaim,omitempty&quot;`

    // ResourceRequest represents the resources required by each replica.
    // +optional
    ResourceRequest corev1.ResourceList `json:&quot;resourceRequest,omitempty&quot;`
}

// NodeClaim represents the node claim HardNodeAffinity, NodeSelector and Tolerations required by each replica.
type NodeClaim struct {
    // A node selector represents the union of the results of one or more label queries over a set of
    // nodes; that is, it represents the OR of the selectors represented by the node selector terms.
    // Note that only PodSpec.Affinity.NodeAffinity.RequiredDuringSchedulingIgnoredDuringExecution
    // is included here because it has a hard limit on pod scheduling.
    // +optional
    HardNodeAffinity *corev1.NodeSelector `json:&quot;hardNodeAffinity,omitempty&quot;`
    // NodeSelector is a selector which must be true for the pod to fit on a node.
    // Selector which must match a node's labels for the pod to be scheduled on that node.
    // +optional
    NodeSelector map[string]string `json:&quot;nodeSelector,omitempty&quot;`
    // If specified, the pod's tolerations.
    // +optional
    Tolerations []corev1.Toleration `json:&quot;tolerations,omitempty&quot;`
}
</code></pre>
<h3 id="karmada-scheduler">Karmada Scheduler</h3>
<p>First, the existing plugins in Karmada Scheduler such as ClusterAffinity, APIInstalled and TaintToleration will select the suitable clusters.</p>
<p>Based on this prefilter result, when assigning replicas, the Karmada Scheduler could try to calculate cluster max available replicas by starting gRPC requests concurrently to the Cluster Accurate Scheduler Estimator. At last, the Cluster Accurate Scheduler Estimator will soon return how many available replicas that the cluster could produce. Then the Karmada Scheduler assgin replicas into different clusters in terms of the estimation result.</p>
<p>We could implement this by modifying function calClusterAvailableReplicas to a interface. The previous estimation method, based on <code>ResourceSummary</code> in <code>Cluster.Status</code>, is able to be a default normal estimation approach. Now we could just add a switch to determine whether Cluster Accurate Scheduler Estimator is applied, while the estimator via <code>ResourceSummary</code> could be a default one that does not support disabled. In the future, after the scheduler profile is added, a user could customize the config by using a profile.</p>
<p>Furthermore, replica estimation can be considered as a new scheduler plugin.</p>
<h3 id="karmada-cluster-accurate-scheduler-estimator">Karmada Cluster Accurate Scheduler Estimator</h3>
<p>Cluster Accurate Scheduler Estimator is a independent component that works as a gRPC server. Before its server starts, a pod and node informer associated with a member cluster will be created as a cache. Once the cache has been synced, the gRPC server would start and serve the incoming scheduler request as a replica estimator. Each Cluster Accurate Scheduler Estimator serves for one cluster, as same as <code>karmada-agent</code>.</p>
<p>There are five steps for a scheduler estimation:</p>
<ul>
<li>Verify whether the request meets the requirements.</li>
<li>Find all nodes that matches the node claim.</li>
<li>List nodes by label selector.</li>
<li>Filter nodes by node affinity.</li>
<li>Filter schedulable nodes by taints and tolerations.</li>
<li>Estimate max available replicas in every filter node.</li>
<li>Get pods that assigned to the node.</li>
<li>Calculate node idle resource.</li>
<li>Calculate how many replicas that the node can be divided into, marked as <code>r1</code>.</li>
<li>Calculate the maximum remaining pods that the node allows, marked as <code>r2</code>.</li>
<li>Return the max available replicas --&gt; <code>min(r1, r2)</code>.</li>
<li>Return the sum of all node max available replicas.</li>
</ul>
<h3 id="test-plan">Test Plan</h3>
<ul>
<li>Unit Test covering:</li>
<li>Core changes in Karmada Scheduler that consists of gRPC connection establishment, replica estimation request sending.</li>
<li>Core changes in Karmada Cluster Accurate Scheduler Estimator that consists of node filtering and node idle resource calculation.</li>
<li>E2E Test covering:</li>
<li>Deploy Karmada Cluster Accurate Scheduler Estimator.</li>
<li>Specify different node claim in a workload and test the scheduler result.</li>
</ul></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js" defer></script>
        <script src="../../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
