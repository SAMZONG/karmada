<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>Descheduler - Karmada.io</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Karmada.io</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">What's Karmada <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="/" class="dropdown-item">Karmada</a>
</li>
                                    
<li>
    <a href="../istio-on-karmada/" class="dropdown-item">Use Istio on Karmada</a>
</li>
                                    
<li>
    <a href="../multi-cluster-ingress/" class="dropdown-item">Multi-cluster Ingress</a>
</li>
                                    
<li>
    <a href="../multi-cluster-service/" class="dropdown-item">Multi-cluster Service Discovery</a>
</li>
                                    
<li>
    <a href="../frequently-asked-questions/" class="dropdown-item">FAQ(Frequently Asked Questions)</a>
</li>
                                    
<li>
    <a href="../reserved-namespaces/" class="dropdown-item">Reserved Namespaces</a>
</li>
                                    
<li>
    <a href="../object-association-map/" class="dropdown-item">Karmada Object association mapping</a>
</li>
                                    
<li>
    <a href="../bash-auto-completion-on-linux/" class="dropdown-item">bash auto-completion on Linux</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../userguide/aggregated-api-endpoint/" class="dropdown-item">aggregated-api-endpoint</a>
</li>
                                    
<li>
    <a href="../userguide/cluster-registration/" class="dropdown-item">cluster-registration</a>
</li>
                                    
<li>
    <a href="../userguide/configure-controllers/" class="dropdown-item">configure-controllers</a>
</li>
                                    
<li>
    <a href="../userguide/customizing-resource-interpreter/" class="dropdown-item">customizing-resource-interpreter</a>
</li>
                                    
<li>
    <a href="../userguide/override-policy/" class="dropdown-item">override-policy</a>
</li>
                                    
<li>
    <a href="../userguide/promote-legacy-workload/" class="dropdown-item">promote-legacy-workload</a>
</li>
                                    
<li>
    <a href="../userguide/propagate-dependencies/" class="dropdown-item">propagate-dependencies</a>
</li>
                                    
<li>
    <a href="../userguide/resource-propagating/" class="dropdown-item">resource-propagating</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Installation <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../installation/installation/" class="dropdown-item">Installation</a>
</li>
                                    
<li>
    <a href="../installation/install-kubectl-karmada/" class="dropdown-item">Install kubectl Karmada</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Upgrading <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../upgrading/" class="dropdown-item">upgrading</a>
</li>
                                </ul>
                            </li>
                            <li class="dropdown">
                                <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">Working With <b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../working-with-anp/" class="dropdown-item">Deploy apiserver-network-proxy (ANP)</a>
</li>
                                    
<li>
    <a href="../working-with-argocd/" class="dropdown-item">Working with Argo CD</a>
</li>
                                    
<li>
    <a href="../working-with-filebeat/" class="dropdown-item">Use Filebeat to collect logs of Karmada member clusters</a>
</li>
                                    
<li>
    <a href="../working-with-flux/" class="dropdown-item">Use Flux to support Helm chart propagation</a>
</li>
                                    
<li>
    <a href="../working-with-gatekeeper/" class="dropdown-item">Working with Gatekeeper(OPA)</a>
</li>
                                    
<li>
    <a href="../working-with-kyverno/" class="dropdown-item">Working with Kyverno</a>
</li>
                                    
<li>
    <a href="../working-with-prometheus/" class="dropdown-item">Use Prometheus to monitor Karmada member clusters</a>
</li>
                                    
<li>
    <a href="../working-with-submariner/" class="dropdown-item">Use Submariner to connect the network between Karmada member clusters</a>
</li>
                                    
<li>
    <a href="../working-with-velero/" class="dropdown-item">Integrate Velero to back up and restore Karmada resources</a>
</li>
                                </ul>
                            </li>
                            <li class="navitem">
                                <a href="../troubleshooting/" class="nav-link">troubleshooting</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#descheduler" class="nav-link">Descheduler</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#prerequisites" class="nav-link">Prerequisites</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#example" class="nav-link">Example</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="descheduler">Descheduler</h1>
<p>Users could divide their replicas of a workload into different clusters in terms of available resources of member clusters.
However, the scheduler's decisions are influenced by its view of Karmada at that point of time when a new <code>ResourceBinding</code> 
appears for scheduling. As Karmada multi-clusters are very dynamic and their state changes over time, there may be desire 
to move already running replicas to some other clusters due to lack of resources for the cluster. This may happen when 
some nodes of a cluster failed and the cluster does not have enough resource to accommodate their pods or the estimators 
have some estimation deviation, which is inevitable.</p>
<p>The karmada-descheduler will detect all deployments once in a while, every 2 minutes by default. In every period, it will find out 
how many unschedulable replicas a deployment has in target scheduled clusters by calling karmada-scheduler-estimator. Then 
it will evict them from decreasing <code>spec.clusters</code> and trigger karmada-scheduler to do a 'Scale Schedule' based on the current 
situation. Note that it will take effect only when the replica scheduling strategy is dynamic division.</p>
<h2 id="prerequisites">Prerequisites</h2>
<h3 id="karmada-has-been-installed">Karmada has been installed</h3>
<p>We can install Karmada by referring to <a href="https://github.com/karmada-io/karmada#quick-start">quick-start</a>, or directly run <code>hack/local-up-karmada.sh</code> script which is also used to run our E2E cases.</p>
<h3 id="member-cluster-component-is-ready">Member cluster component is ready</h3>
<p>Ensure that all member clusters have joined Karmada and their corresponding karmada-scheduler-estimator is installed into karmada-host.</p>
<p>Check member clusters using the following command:</p>
<pre><code class="language-bash"># Check whether member clusters have joined
$ kubectl get cluster
NAME       VERSION   MODE   READY   AGE
member1    v1.19.1   Push   True    11m
member2    v1.19.1   Push   True    11m
member3    v1.19.1   Pull   True    5m12s

# check whether the karmada-scheduler-estimator of a member cluster has been working well
$ kubectl --context karmada-host get pod -n karmada-system | grep estimator
karmada-scheduler-estimator-member1-696b54fd56-xt789   1/1     Running   0          77s
karmada-scheduler-estimator-member2-774fb84c5d-md4wt   1/1     Running   0          75s
karmada-scheduler-estimator-member3-5c7d87f4b4-76gv9   1/1     Running   0          72s
</code></pre>
<ul>
<li>If a cluster has not joined, use <code>hack/deploy-agent-and-estimator.sh</code> to deploy both karmada-agent and karmada-scheduler-estimator.</li>
<li>If the clusters have joined, use <code>hack/deploy-scheduler-estimator.sh</code> to only deploy karmada-scheduler-estimator.</li>
</ul>
<h3 id="scheduler-option-enable-scheduler-estimator">Scheduler option '--enable-scheduler-estimator'</h3>
<p>After all member clusters have joined and estimators are all ready, specify the option <code>--enable-scheduler-estimator=true</code> to enable scheduler estimator.</p>
<pre><code class="language-bash"># edit the deployment of karmada-scheduler
$ kubectl --context karmada-host edit -n karmada-system deployments.apps karmada-scheduler
</code></pre>
<p>Add the option <code>--enable-scheduler-estimator=true</code> into the command of container <code>karmada-scheduler</code>.</p>
<h3 id="descheduler-has-been-installed">Descheduler has been installed</h3>
<p>Ensure that the karmada-descheduler has been installed onto karmada-host.</p>
<pre><code class="language-bash">$ kubectl --context karmada-host get pod -n karmada-system | grep karmada-descheduler
karmada-descheduler-658648d5b-c22qf                    1/1     Running   0          80s
</code></pre>
<h2 id="example">Example</h2>
<p>Let's simulate a replica scheduling failure in a member cluster due to lack of resources.</p>
<p>First we create a deployment with 3 replicas and divide them into 3 member clusters.</p>
<pre><code class="language-yaml">apiVersion: policy.karmada.io/v1alpha1
kind: PropagationPolicy
metadata:
  name: nginx-propagation
spec:
  resourceSelectors:
    - apiVersion: apps/v1
      kind: Deployment
      name: nginx
  placement:
    clusterAffinity:
      clusterNames:
        - member1
        - member2
        - member3
    replicaScheduling:
      replicaDivisionPreference: Weighted
      replicaSchedulingType: Divided
      weightPreference:
        dynamicWeight: AvailableReplicas
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  replicas: 3
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - image: nginx
        name: nginx
        resources:
          requests:
            cpu: &quot;2&quot;
</code></pre>
<p>It is possible for these 3 replicas to be evenly divided into 3 member clusters, that is, one replica in each cluster.
Now we taint all nodes in member1 and evict the replica.</p>
<pre><code class="language-bash">$ kubectl --context member1 cordon member1-control-plane
$ kubectl --context member1 delete pod nginx-68b895fcbd-jgwz6
</code></pre>
<p>A new pod will be created and cannot be scheduled by <code>kube-scheduler</code> due to lack of resources.</p>
<pre><code class="language-bash">$ kubectl --context member1 get pod
NAME                     READY   STATUS    RESTARTS   AGE
nginx-68b895fcbd-fccg4   1/1     Pending   0          80s
</code></pre>
<p>After about 5 to 7 minutes, the pod in member1 will be evicted and scheduled to other available clusters.</p>
<pre><code class="language-bash">$ kubectl --context member1 get pod
No resources found in default namespace.
# kubectl --context member2 get pod
NAME                     READY   STATUS    RESTARTS   AGE
nginx-68b895fcbd-dgd4x   1/1     Running   0          6m3s
nginx-68b895fcbd-nwgjn   1/1     Running   0          4s
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
